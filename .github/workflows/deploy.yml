name: Deploy Crhodis App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment variables
      run: |
        echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV
        echo "MODEL=deepseek/deepseek-chat-v3.1:free" >> $GITHUB_ENV

    - name: Test backend startup
      run: |
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        python -c "
        import threading
        import time
        from main import run_backend
        
        def run_server():
            run_backend()
        
        server_thread = threading.Thread(target=run_server, daemon=True)
        server_thread.start()
        time.sleep(5)
        print('âœ… Server started successfully')
        " &

    - name: Basic functionality test
      run: |
        # Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„
        python -c "
        from main import app, ask_ai_model
        print('âœ… All imports successful')
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ
        from main import clean_text
        test_text = '**Hello** ##World##'
        cleaned = clean_text(test_text)
        print(f'âœ… Clean text function: {cleaned}')
        "

    - name: Verify API key
      run: |
        python -c "
        import os
        api_key = os.environ.get('OPENROUTER_API_KEY', '')
        if api_key and api_key != 'your-api-key-here':
            print('âœ… API key is set correctly')
        else:
            print('âš ï¸  API key not set or using default value')
            print('ğŸ’¡ Please add OPENROUTER_API_KEY to GitHub Secrets')
        "
