name: Deploy Crhodis App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment variables
      run: |
        echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV
        echo "MODEL=deepseek/deepseek-chat-v3.1:free" >> $GITHUB_ENV

    - name: Test backend startup
      run: |
        # تشغيل الخادم في الخلفية
        python -c "
        import threading
        import time
        from main import run_backend
        
        def run_server():
            run_backend()
        
        server_thread = threading.Thread(target=run_server, daemon=True)
        server_thread.start()
        time.sleep(5)
        print('✅ Server started successfully')
        " &

    - name: Basic functionality test
      run: |
        # اختبار بسيط للتأكد من أن الكود يعمل
        python -c "
        from main import app, ask_ai_model
        print('✅ All imports successful')
        
        # اختبار دالة التنظيف
        from main import clean_text
        test_text = '**Hello** ##World##'
        cleaned = clean_text(test_text)
        print(f'✅ Clean text function: {cleaned}')
        "

    - name: Verify API key
      run: |
        python -c "
        import os
        api_key = os.environ.get('OPENROUTER_API_KEY', '')
        if api_key and api_key != 'your-api-key-here':
            print('✅ API key is set correctly')
        else:
            print('⚠️  API key not set or using default value')
            print('💡 Please add OPENROUTER_API_KEY to GitHub Secrets')
        "
